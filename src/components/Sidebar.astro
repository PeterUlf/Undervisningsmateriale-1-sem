---
import type { Props } from '@astrojs/starlight/props';
import Default from '@astrojs/starlight/components/Sidebar.astro';
---

<div id="theme-filter-container">
  <label for="theme-select">Vis temaer:</label>
  <select id="theme-select">
    <option value="all">Alle temaer</option>
  </select>
</div>

<Default {...Astro.props}><slot /></Default>

<script>
  // Rod-elementet for Starlight-sidebaren
  const sidebarRoot = document.getElementById('starlight__sidebar');

  if (sidebarRoot) {
    // Find alle unikke tema-numre dynamisk
    const badgeNodes = sidebarRoot.querySelectorAll('a .sl-badge');
    const themeNumbers = new Set<number>();
    
    badgeNodes.forEach((badge) => {
      const badgeText = badge.textContent?.trim();
      if (badgeText?.startsWith('Tema')) {
        const themeNumber = parseInt(badgeText.replace('Tema ', ''));
        if (!isNaN(themeNumber)) {
          themeNumbers.add(themeNumber);
        }
      }
    });
    
    // Sorter tema-numre
    const sortedThemes = Array.from(themeNumbers).sort((a, b) => a - b);
    
    // Byg options dynamisk
    const select = document.getElementById('theme-select') as HTMLSelectElement;
    
    if (select && sortedThemes.length > 0) {
      // Tema navne
      const themeNames: { [key: number]: string } = {
        1: 'Introuge',
        2: 'Web I',
        3: 'UX I',
        4: 'Brugergrænseflade udvikling I',
        5: 'Indhold I',
        6: 'Eksamen',
        7: 'Indhold II',
        8: 'Web II'
      };
      
      // Tilføj tema options (ét tema ad gangen)
      sortedThemes.forEach(num => {
        const option = document.createElement('option');
        option.value = num.toString();
        const themeName = themeNames[num] || '';
        option.textContent = themeName ? `Tema ${num} - ${themeName}` : `Tema ${num}`;
        select.appendChild(option);
      });
      
      // Hent gemt valg eller check for URL parameter
      const urlParams = new URLSearchParams(window.location.search);
      const urlTheme = urlParams.get('tema');
      const savedTheme = urlTheme || localStorage.getItem('selectedTheme') || 'all';
      select.value = savedTheme;
      
      // Gem tema fra URL til localStorage
      if (urlTheme) {
        localStorage.setItem('selectedTheme', urlTheme);
      }
      
      // Funktion til at filtrere
      function filterMenuItems(selectedTheme: string) {
        const isAll = selectedTheme === 'all';
        const selectedThemeNum = isAll ? null : parseInt(selectedTheme);

        // Filtrér alle links i den rigtige sidebar
        const sidebarLinks = sidebarRoot!.querySelectorAll('a');

        sidebarLinks.forEach((link) => {
          const badge = link.querySelector('.sl-badge');
          const listItem = link.closest('li');
          if (!listItem) return;

          const liEl = listItem as HTMLElement;

          // Hvis der ikke er noget badge, så skjul punktet når der filtreres på et specifikt tema
          if (!badge) {
            liEl.style.display = isAll ? '' : 'none';
            return;
          }

          const badgeText = badge.textContent?.trim();

          // Kun badges med "Tema X" tæller som temamærker
          if (badgeText?.startsWith('Tema ')) {
            const themeNumber = parseInt(badgeText.replace('Tema ', ''));

            if (isAll || isNaN(themeNumber) || selectedThemeNum === null) {
              liEl.style.display = '';
            } else {
              // Vis KUN det valgte tema (ikke "op til")
              liEl.style.display = themeNumber === selectedThemeNum ? '' : 'none';
            }
          } else {
            // Andre badges (fx bare "Tema") skjules også ved filtrering
            liEl.style.display = isAll ? '' : 'none';
          }
        });
        
        // Skjul tomme grupper: en gruppe er tom hvis den ingen SYNLIGE links har
        const sidebarGroups = sidebarRoot!.querySelectorAll('details');
        sidebarGroups.forEach((group) => {
          const links = Array.from(group.querySelectorAll('a'));
          const visibleLinks = links.filter((link) => {
            const li = link.closest('li');
            return li && (li as HTMLElement).style.display !== 'none';
          });

          const detailsEl = group as HTMLDetailsElement;
          detailsEl.style.display = visibleLinks.length === 0 ? 'none' : '';
          
          // Luk alle details når "Alle temaer" er valgt, åbn dem når et specifikt tema er valgt
          if (isAll) {
            detailsEl.open = false;
          } else if (visibleLinks.length > 0) {
            detailsEl.open = true;
          }
        });
      }
      
      // Filtrer ved load
      filterMenuItems(savedTheme);
      
      // Lyt efter ændringer
      select.addEventListener('change', (e) => {
        const selectedTheme = (e.target as HTMLSelectElement).value;
        localStorage.setItem('selectedTheme', selectedTheme);
        filterMenuItems(selectedTheme);
      });
    }
  }
</script>

<style>
  #theme-filter-container {
    padding: 1rem;
    border-bottom: 1px solid var(--sl-color-gray-5);
    margin-bottom: 1rem;
  }

  #theme-filter-container label {
    display: block;
    font-weight: 600;
    font-size: var(--sl-text-sm);
    color: var(--sl-color-white);
    margin-bottom: 0.5rem;
  }

  #theme-select {
    width: 100%;
    padding: 0.5rem;
    background: var(--sl-color-gray-6);
    color: var(--sl-color-white);
    border: 1px solid var(--sl-color-gray-5);
    border-radius: 0.375rem;
    font-size: var(--sl-text-sm);
    cursor: pointer;
  }

  #theme-select:hover {
    background: var(--sl-color-gray-5);
  }

  #theme-select:focus {
    outline: 2px solid var(--sl-color-accent);
    outline-offset: 2px;
  }
</style>
