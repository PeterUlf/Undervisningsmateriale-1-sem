---
import type { Props } from '@astrojs/starlight/props';
import Default from '@astrojs/starlight/components/Sidebar.astro';
---

<div id="theme-filter-container">
  <label for="theme-select">Vis temaer:</label>
  <select id="theme-select">
    <option value="all">Alle temaer</option>
  </select>
</div>

<Default {...Astro.props}><slot /></Default>

<script>
  // Find alle unikke tema-numre dynamisk
  const sidebarLinks = document.querySelectorAll('.sidebar a .sl-badge');
  const themeNumbers = new Set<number>();
  
  sidebarLinks.forEach((badge) => {
    const badgeText = badge.textContent?.trim();
    if (badgeText?.startsWith('Tema')) {
      const themeNumber = parseInt(badgeText.replace('Tema ', ''));
      if (!isNaN(themeNumber)) {
        themeNumbers.add(themeNumber);
      }
    }
  });
  
  // Sorter tema-numre
  const sortedThemes = Array.from(themeNumbers).sort((a, b) => a - b);
  
  // Byg options dynamisk
  const select = document.getElementById('theme-select') as HTMLSelectElement;
  
  if (select && sortedThemes.length > 0) {
    // Tilføj tema options
    sortedThemes.forEach(num => {
      const option = document.createElement('option');
      option.value = num.toString();
      option.textContent = `Op til Tema ${num}`;
      select.appendChild(option);
    });
    
    // Hent gemt valg
    const savedTheme = localStorage.getItem('selectedTheme') || 'all';
    select.value = savedTheme;
    
    // Funktion til at filtrere
    function filterMenuItems(maxTheme: string) {
      const sidebarLinks = document.querySelectorAll('.sidebar a');
      
      sidebarLinks.forEach((link) => {
        const badge = link.querySelector('.sl-badge');
        
        if (badge) {
          const badgeText = badge.textContent?.trim();
          
          if (badgeText?.startsWith('Tema')) {
            const themeNumber = parseInt(badgeText.replace('Tema ', ''));
            const listItem = link.closest('li');
            
            if (maxTheme === 'all') {
              if (listItem) (listItem as HTMLElement).style.display = '';
            } else {
              const maxThemeNum = parseInt(maxTheme);
              if (listItem) {
                (listItem as HTMLElement).style.display = themeNumber <= maxThemeNum ? '' : 'none';
              }
            }
          }
        }
      });
      
      // Skjul tomme grupper
      const sidebarGroups = document.querySelectorAll('.sidebar details');
      sidebarGroups.forEach((group) => {
        const visibleItems = group.querySelectorAll('li:not([style*="display: none"])');
        (group as HTMLElement).style.display = visibleItems.length > 0 ? '' : 'none';
      });
    }
    
    // Filtrer ved load
    filterMenuItems(savedTheme);
    
    // Lyt efter ændringer
    select.addEventListener('change', (e) => {
      const selectedTheme = (e.target as HTMLSelectElement).value;
      localStorage.setItem('selectedTheme', selectedTheme);
      filterMenuItems(selectedTheme);
    });
  }
</script>

<style>
  #theme-filter-container {
    padding: 1rem;
    border-bottom: 1px solid var(--sl-color-gray-5);
    margin-bottom: 1rem;
  }

  #theme-filter-container label {
    display: block;
    font-weight: 600;
    font-size: var(--sl-text-sm);
    color: var(--sl-color-white);
    margin-bottom: 0.5rem;
  }

  #theme-select {
    width: 100%;
    padding: 0.5rem;
    background: var(--sl-color-gray-6);
    color: var(--sl-color-white);
    border: 1px solid var(--sl-color-gray-5);
    border-radius: 0.375rem;
    font-size: var(--sl-text-sm);
    cursor: pointer;
  }

  #theme-select:hover {
    background: var(--sl-color-gray-5);
  }

  #theme-select:focus {
    outline: 2px solid var(--sl-color-accent);
    outline-offset: 2px;
  }
</style>
